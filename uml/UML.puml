@startuml


' Enumerations
enum RetrievalAlgorithms {
    RANDOM
    UNIMODAL
    EARLY_FUSION
    LATE_FUSION
    NEURAL_NETWORK
}

enum Modality {
    AUDIO
    LYRICS
    VIDEO
    AUDIO_AUDIO
    AUDIO_LYRICS
    AUDIO_VIDEO
    LYRICS_LYRICS
    LYRICS_AUDIO
    LYRICS_VIDEO
    VIDEO_AUDIO
    VIDEO_LYRICS
    VIDEO_VIDEO
    ALL
}


' Abstract Base Class
abstract class RetrievalStrategy {
    {abstract} +search(query_id: str, k: int)
}

' Strategy Implementations
class RandomStrategy {
    -rs_instance
    +search(query_id, k)
}

class UnimodalStrategy {
    -rs_instance
    -modality
    +search(query_id, k)
}

class EarlyFusionStrategy {
    -rs_instance
    -modalities
    +search(query_id, k)
}

class LateFusionStrategy {
    -rs_instance
    -modalities
    +search(query_id, k)
}

class NeuralNetworkStrategy {
    -rs_instance
    -modalities
    +search(query_id, k)
}



' Retrieval Systems
class RandomBaselineRetrievalSystem {
    -evaluator: Evaluator
    -rng
    +rankings(query_id)
    +retrieve(query_id, k_neighbors)
}


class UnimodalRetrievalSystem {
    -data_root
    -evaluator: Evaluator
    -features
    -modality
    +set_modality(modality)
    +rankings(query_id)
    +retrieve(query_id, k_neighbors)
}


class EarlyFusionRetrievalSystem {
    -data_root
    -evaluator: Evaluator
    -features
    -fused_features_path
    -id_mapping_path
    -use_pca
    -modality
    -_build_cache(modalities)
    -_load_cache(modalities)
    +rankings(query_id)
}


class LateFusionRetrievalSystem {
    -data_root
    -evaluator: Evaluator
    -features
    -modalitiy
    -alpha
    -eps
    -fusion
    -norm
    -rrf_k
    -topL
    -used_modalities
    -weighting
    +set_modality(modality)
    -_zscore(x, eps)
    -_minmax(x, eps)
    -_auto_weights_by_agreement(scores_by_modality)
    +rankings(query_id)
    +retrieve(query_id, k_neighbors)
}
class NeuralNetworkBasedRetrievalSystem {
    -data_root
    -evaluator: Evaluator
    -f1
    -f2
    -_preprocess_data(f1, f2)
    +rankings(query_id)
    +retrieve(query_id, k_neighbors)
}


' Evaluator
class Evaluator {
    -genres
    -jaccard
    -threshold
    -compute_jaccard()
    -pop_at_k(query_id, rankings, transform)
    -catalog_poplularity(transform)
    +precision(query_id, rankings, k)
    +recall(query_id, rankings, k)
    +mrr(query_id, rankings, k)
    +ndcg(query_id, rankings, k)
    +precision_overlap(query_id, rankings, k)
    +recall_overlap(query_id, rankings, k)
    +mrr_overlap(query_id, rankings, k)
    +ndcg_overlap(query_id, rankings, k)
}


' Main Application (simplified)
class Yamex <<main>> {
    +main(page: ft.Page)
    -on_search_change(e)
    -clear_search_results(e)
    -handle_dropdown_algo_and_mod(e)
    -handle_search_now()
    -execute_retrieval(query_id)
    -display_result_card(song_id, idx, score)
    -clear_history_log(e)
}

' Relationships

' Strategy Pattern
RetrievalStrategy <|-- RandomStrategy
RetrievalStrategy <|-- UnimodalStrategy
RetrievalStrategy <|-- EarlyFusionStrategy
RetrievalStrategy <|-- LateFusionStrategy
RetrievalStrategy <|-- NeuralNetworkStrategy

' Strategy uses Retrieval Systems
RandomStrategy o-- RandomBaselineRetrievalSystem
UnimodalStrategy o-- UnimodalRetrievalSystem
EarlyFusionStrategy o-- EarlyFusionRetrievalSystem
LateFusionStrategy o-- LateFusionRetrievalSystem
NeuralNetworkStrategy o-- NeuralNetworkBasedRetrievalSystem

' Retrieval Systems depend on Evaluator
RandomBaselineRetrievalSystem *-- Evaluator
UnimodalRetrievalSystem *-- Evaluator
EarlyFusionRetrievalSystem *-- Evaluator
LateFusionRetrievalSystem *-- Evaluator
NeuralNetworkBasedRetrievalSystem *-- Evaluator

' Main app uses all systems
Yamex ..> RandomBaselineRetrievalSystem
Yamex ..> UnimodalRetrievalSystem
Yamex ..> EarlyFusionRetrievalSystem
Yamex ..> LateFusionRetrievalSystem
Yamex ..> NeuralNetworkBasedRetrievalSystem
Yamex ..> Evaluator

' Main app uses strategies
Yamex ..> RetrievalStrategy
Yamex ..> RetrievalAlgorithms
Yamex .[hidden]right- RetrievalStrategy
Yamex ..> Modality



' Strategies use Modality
UnimodalStrategy ..> Modality
EarlyFusionStrategy ..> Modality
LateFusionStrategy ..> Modality
NeuralNetworkStrategy ..> Modality
@enduml
